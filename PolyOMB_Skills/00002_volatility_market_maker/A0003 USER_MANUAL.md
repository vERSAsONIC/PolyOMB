# 00002 VolatilityMarketMaker 用户操作手册

> 详细的界面操作指南

---

## 📖 目录

1. [环境准备](#环境准备)
2. [启动界面](#启动界面)
3. [Skill管理界面](#skill管理界面)
4. [回试运行界面](#回试运行界面)
5. [结果图表展示](#结果图表展示)
6. [参数配置界面](#参数配置界面)
7. [完整工作流示例](#完整工作流示例)
8. [常见问题](#常见问题)

---

## 环境准备

### 1. 安装依赖

```bash
# 进入项目目录
cd PolyOMB_Skills/00002_volatility_market_maker

# 安装必要依赖
pip install streamlit plotly pyyaml pandas numpy
```

### 2. 验证安装

```bash
python -c "import streamlit; import plotly; print('✅ 依赖安装成功')"
```

### 3. 检查SMB挂载（可选）

如果使用真实数据，确保SMB已挂载：

```bash
ls /Volumes/liuqiong/prediction-market-analysis/data/
```

---

## 启动界面

### 方式1: 启动 Skill管理界面

```bash
cd PolyOMB_Skills/00002_volatility_market_maker
python -m streamlit run ui/skill_manager.py
```

浏览器自动打开: `http://localhost:8501`

### 方式2: 启动 回试运行界面

```bash
cd PolyOMB_Skills/00002_volatility_market_maker
python -m streamlit run ui/backtest_runner.py
```

### 方式3: 启动 结果图表展示

```bash
cd PolyOMB_Skills/00002_volatility_market_maker
python -m streamlit run ui/result_charts.py
```

### 方式4: 启动 参数配置界面

```bash
cd PolyOMB_Skills/00002_volatility_market_maker
python -m streamlit run ui/param_config.py
```

### 方式5: 启动完整应用（推荐）

创建一个启动脚本 `run_app.py`:

```python
import streamlit as st
from ui.skill_manager import SkillManager
from ui.backtest_runner import BacktestRunner
from ui.param_config import ParamConfig

st.set_page_config(
    page_title="PolyOMB - VolatilityMarketMaker",
    page_icon="📈",
    layout="wide"
)

# 侧边栏导航
st.sidebar.title("📦 导航")
page = st.sidebar.radio(
    "选择功能",
    ["Skill管理", "回试运行", "参数配置"]
)

if page == "Skill管理":
    manager = SkillManager()
    manager.run()
elif page == "回试运行":
    runner = BacktestRunner()
    runner.run()
elif page == "参数配置":
    config = ParamConfig()
    config.run()
```

运行:
```bash
python -m streamlit run run_app.py
```

---

## Skill管理界面

### 界面概览

```
┌─────────────────────────────────────────────────────────────┐
│  📦 PolyOMB Skill Manager                                    │
├──────────────────────────┬──────────────────────────────────┤
│                          │                                  │
│  📊 筛选器               │  📋 Skill 详情                   │
│  ─────────────────       │  ────────────────────────────── │
│  [搜索框...]             │                                  │
│                          │  📈 VolatilityMarketMaker       │
│  📁 类别                 │  ID: 00002_volatility_mark...    │
│  ☑ Politics              │  版本: 1.0.0                     │
│  ☑ Crypto                │  作者: PolyOMB Team              │
│  ☑ Tech                  │  状态: ✅ active                 │
│                          │                                  │
│                          │  [▶️ 运行] [⚙️ 配置]             │
│                          │                                  │
├──────────────────────────┤                                  │
│  📦 已安装 Skills (1)    │                                  │
│  ┌─────────────────┐     │                                  │
│  │      📈         │     │                                  │
│  │ VolatilityMM    │     │                                  │
│  │   v1.0.0        │     │                                  │
│  │   🟢 active     │     │                                  │
│  │ [▶️] [⚙️]       │     │                                  │
│  └─────────────────┘     │                                  │
│                          │                                  │
└──────────────────────────┴──────────────────────────────────┘
```

### 操作步骤

#### 1. 查看Skill列表

- 左侧显示所有已安装的Skills
- 每个Skill显示：图标、名称、版本、状态

#### 2. 搜索Skill

- 在左侧搜索框输入关键词
- 实时过滤显示匹配的Skills

#### 3. 按类别筛选

- 勾选/取消勾选类别复选框
- 支持多类别同时筛选

#### 4. 查看Skill详情

- 点击任意Skill卡片
- 右侧面板显示详细信息：
  - Skill完整名称
  - 版本号
  - 作者信息
  - 状态指示器
  - 描述信息
  - 依赖状态

#### 5. 运行Skill

- 点击Skill卡片上的 "▶️ 运行" 按钮
- 或点击详情面板的 "▶️ 激活" 按钮

#### 6. 配置Skill

- 点击 "⚙️ 配置" 按钮
- 跳转到参数配置界面

---

## 回试运行界面

### 界面概览

```
┌──────────┬──────────────┬────────────────────────────────────┐
│          │              │                                    │
│  📊      │  📋          │  📈 分析结果                        │
│  筛选器   │  Question    │  ─────────────────────────────    │
│          │  列表        │                                    │
│  20%     │  30%         │  50%                               │
│          │              │                                    │
│ 1️⃣ 数据源 │  🔍 搜索...  │  Will Trump win 2024?             │
│          │              │  • Yes: 0.65 • No: 0.35           │
│ ○ Historical│            │                                    │
│ ● Parquet │  ┌────────┐ │  📊 价格波动图表                    │
│          │  │ ✅ Will │ │  [图表区域]                        │
│ ○ Realtime│  │ Trump  │ │                                    │
│          │  │ win... │ │  📈 策略信号图表                    │
│ 2️⃣ Market│  │ [分析] │ │  [图表区域]                        │
│          │  └────────┘ │                                    │
│ ☑ Politics│             │  📋 交易记录                        │
│ ☑ Crypto │  ┌────────┐ │  | 时间 | 类型 | 价格 | 盈亏 |     │
│ ☐ Sports │  │ ✅ ETH │ │                                    │
│ ☑ Tech   │  │ reach  │ │  ⚙️ 策略参数                        │
│          │  │ $5k?   │ │  止损: -5%  止盈: +3%             │
│ 3️⃣ 时间   │  └────────┘ │  [修改参数] [重跑]                │
│          │              │                                    │
│ ○ 生命周期│              │  📊 统计指标                        │
│ ● 自定义  │              │  收益率: +12.5%  夏普: 1.85       │
│          │              │                                    │
│ [应用筛选]│              │                                    │
│          │              │                                    │
└──────────┴──────────────┴────────────────────────────────────┘
```

### 操作步骤

#### 1. 选择数据源

- **Historical Data (Parquet)**: 使用本地历史数据
- **Real-time API (Gamma)**: 使用实时API（未来支持）

#### 2. 筛选Market类别

- 勾选感兴趣的市场类别
- 可选: Politics, Crypto, Sports, Tech

#### 3. 搜索Question

- 在搜索框输入关键词（如 "Trump", "ETH"）
- 实时过滤Question列表

#### 4. 选择时间范围

**预设选项**:
- 近7天
- 近30天
- 本季度
- 全年
- 生命周期（全部历史数据）

**自定义**:
- 选择 "自定义区间"
- 设置开始日期和结束日期

#### 5. 应用筛选

- 点击 "🔄 应用筛选" 按钮
- Question列表会根据条件更新

#### 6. 选择Question分析

- 在中列浏览Question列表
- 每个Question显示：
  - 问题描述
  - 市场类别
  - 流动性
  - Outcomes及当前价格
- 点击 "🔍 分析" 按钮

#### 7. 查看分析结果

右侧面板显示：

**📊 价格波动图表**
- 历史价格走势
- 买卖挂单深度
- 成交标记点

**📈 策略信号图表**
- 买入/卖出信号标记
- 持仓变化曲线
- PnL曲线

**📋 交易记录**
- 时间、类型、价格、数量、盈亏
- 支持排序和导出

**⚙️ 策略参数**
- 实时调整参数
- 点击 "修改参数" 保存
- 点击 "重跑" 重新计算

**📊 统计指标**
- 总收益率
- 夏普比率
- 最大回撤
- 胜率

---

## 结果图表展示

### 独立启动

```bash
python -m streamlit run ui/result_charts.py
```

### 图表说明

#### 价格走势图

**功能**:
- 显示历史价格走势
- 标记买卖点（绿色三角形=买入，红色三角形=卖出）
- 显示买卖挂单深度（虚线）

**交互**:
- 鼠标悬停查看详细数据
- 缩放查看特定时间段
- 平移浏览历史数据

#### 策略信号图

**上半部分 - 交易信号**:
- 绿色向上三角形 = 买入信号
- 红色向下三角形 = 卖出信号

**下半部分 - 持仓变化**:
- 蓝色区域 = 持仓数量
- 零线 = 无持仓

#### PnL曲线

**上半部分 - 累计盈亏**:
- 紫色曲线 = 累计盈亏
- 零线 = 盈亏平衡点
- 正值 = 盈利，负值 = 亏损

**下半部分 - 每日盈亏**:
- 绿色柱状 = 盈利日
- 红色柱状 = 亏损日

#### 统计指标卡片

| 指标 | 说明 |
|------|------|
| 总收益率 | 整个回测期间的累计收益百分比 |
| 夏普比率 | 风险调整后的收益指标 |
| 最大回撤 | 从峰值到谷底的最大亏损 |
| 胜率 | 盈利交易次数 / 总交易次数 |
| 交易次数 | 总交易笔数 |
| 盈亏比 | 平均盈利 / 平均亏损 |
| 平均盈利 | 盈利交易的平均收益 |
| 平均亏损 | 亏损交易的平均损失 |

---

## 参数配置界面

### 界面概览

```
┌──────────────────────────────────┬─────────────────────────────┐
│                                  │                             │
│  ⚙️ 策略参数配置                  │  📋 当前配置                 │
│                                  │                             │
│  ### 🛡️ 风控参数                 │  **风控参数**                │
│                                  │  - 止损: -5.0%              │
│  **止损阈值** (%)                 │  - 止盈: +3.0%              │
│  当亏损达到此百分比时触发止损      │  - 波动率: 0.15             │
│  [-5.0]                          │  - 暂停期: 6h               │
│                                  │                             │
│  **止盈阈值** (%)                 │  **交易参数**                │
│  当盈利达到此百分比时触发止盈      │  - 最大持仓: 250            │
│  [+3.0]                          │  - 交易数量: 50             │
│                                  │  - 最小数量: 5              │
│  **波动率阈值**                   │  - 价差: 0.020              │
│  3小时波动率超过此值时暂停交易     │                             │
│  [0.15 ▼▼▼]                      │  ✅ 参数有效                 │
│                                  │                             │
│  **暂停期** (小时)                │  ### 📖 参数说明             │
│  止损后的暂停交易时间              │  **止损阈值**: 触发止损...   │
│  [6 ▼▼▼]                         │  **止盈阈值**: 触发止盈...   │
│                                  │  ...                        │
│  ### 💼 交易参数                 │                             │
│                                  │                             │
│  最大持仓        交易数量         │                             │
│  [250]           [50]            │                             │
│                                  │                             │
│  最小数量        价差阈值         │                             │
│  [5]             [0.02]          │                             │
│                                  │                             │
│  [💾 保存配置]  [🔄 重置默认]    │                             │
│  [🚀 重新运行]                   │                             │
│                                  │                             │
└──────────────────────────────────┴─────────────────────────────┘
```

### 参数说明

#### 风控参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 止损阈值 | -5% | -20% ~ 0% | 亏损达到此百分比时触发止损 |
| 止盈阈值 | +3% | 0% ~ 20% | 盈利达到此百分比时触发止盈 |
| 波动率阈值 | 0.15 | 0.01 ~ 1.0 | 3小时波动率超过此值暂停交易 |
| 暂停期 | 6小时 | 1 ~ 48小时 | 止损后的冷却时间 |

#### 交易参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 最大持仓 | 250 | 1 ~ 1000 | 允许的最大持仓数量 |
| 交易数量 | 50 | 1 ~ 1000 | 每次下单的数量 |
| 最小数量 | 5 | 1 ~ 100 | 最小允许的交易数量 |
| 价差阈值 | 0.02 | 0.001 ~ 0.1 | 止损时的最小价差要求 |

### 操作步骤

#### 1. 修改参数

- 在输入框中输入新值
- 或使用滑块调整
- 系统会实时验证参数范围

#### 2. 验证参数

- 右侧面板显示 "✅ 参数有效" 或 "❌ 参数有误"
- 如果有误，会显示具体错误信息

#### 3. 保存配置

- 点击 "💾 保存配置" 按钮
- 配置保存到 `{skill_id}_config.yaml`

#### 4. 重置默认

- 点击 "🔄 重置默认" 按钮
- 所有参数恢复为默认值

#### 5. 重新运行

- 点击 "🚀 重新运行" 按钮
- 使用新参数重新运行回测

---

## 完整工作流示例

### 场景：分析特朗普2024选举市场

```
步骤1: 启动应用
─────────────────────────
python -m streamlit run run_app.py

步骤2: 进入回试运行界面
─────────────────────────
点击左侧导航栏 "回试运行"

步骤3: 设置筛选条件
─────────────────────────
1. 数据源: 选择 "Historical Data (Parquet)"
2. Market类别: 勾选 "Politics"
3. 搜索: 输入 "Trump"
4. 时间范围: 选择 "生命周期"
5. 点击 "🔄 应用筛选"

步骤4: 选择Question
─────────────────────────
在Question列表中找到:
"Will Donald Trump win the 2024 US Presidential Election?"
点击 "🔍 分析" 按钮

步骤5: 查看分析结果
─────────────────────────
在右侧面板查看:
- 价格走势图
- 策略信号
- 交易记录
- 统计指标

步骤6: 调整参数（可选）
─────────────────────────
1. 进入 "参数配置" 页面
2. 修改止损为 -3%
3. 修改止盈为 +5%
4. 点击 "💾 保存配置"
5. 返回回试运行界面
6. 点击 "🔄 重新运行"

步骤7: 导出结果
─────────────────────────
在交易记录表格下方点击 "导出CSV"
```

---

## 常见问题

### Q1: Streamlit启动失败

**错误**: `ModuleNotFoundError: No module named 'streamlit'`

**解决**:
```bash
pip install streamlit plotly pyyaml
```

### Q2: SMB数据无法访问

**错误**: 数据加载超时或找不到文件

**解决**:
1. 检查SMB挂载状态:
   ```bash
   mount | grep smb
   ```
2. 如果未挂载，手动挂载:
   ```bash
   mount_smbfs //user@server/share /Volumes/share
   ```
3. 或使用Mock数据进行测试

### Q3: 图表显示空白

**可能原因**:
- 数据为空
- Plotly未正确安装

**解决**:
```bash
pip install --upgrade plotly
```

### Q4: 参数保存失败

**可能原因**:
- 文件权限不足
- 磁盘空间不足

**解决**:
```bash
# 检查权限
ls -la PolyOMB_Skills/00002_volatility_market_maker/

# 修改权限
chmod 755 PolyOMB_Skills/00002_volatility_market_maker/
```

### Q5: 界面布局错乱

**解决**:
1. 刷新浏览器页面 (F5)
2. 清除浏览器缓存
3. 重启Streamlit服务

---

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| `R` | 重新运行脚本 |
| `C` | 清除缓存 |
| `S` | 停止服务器 |
| `F5` | 刷新页面 |

---

## 联系与支持

如有问题，请查看:
- 技术文档: `A0012 VolatilityMarketMaker Skill 架构规划.md`
- 版本历史: `A0001 VERSION_HISTORY.md`
- 测试报告: `tests/A0001 测试覆盖率报告.md`

---

**文档版本**: 1.0  
**更新日期**: 2026-02-19  
**适用版本**: V2 + Phase 3
