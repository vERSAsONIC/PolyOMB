# 00002 MarketDataLoader - é«˜æ•ˆå¸‚åœºæ•°æ®åŠ è½½å™¨

> ä¸º 00002_volatility_market_maker Skill æä¾›é«˜æ•ˆçš„æ•°æ®åŠ è½½åŠŸèƒ½

---

## ğŸ“‹ æ¦‚è¿°

`MarketDataLoader` æ˜¯ä¸€ä¸ªä¸“ä¸º Polymarket å†å²æ•°æ®è®¾è®¡çš„é«˜æ•ˆæ•°æ®åŠ è½½å™¨ï¼Œè§£å†³äº† SMB æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ…¢çš„é—®é¢˜ã€‚

### ä¸»è¦ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æœ¬åœ°ç¼“å­˜** | è‡ªåŠ¨ç¼“å­˜ markets å’Œ trades æ•°æ®åˆ°æœ¬åœ°ç£ç›˜ |
| **æ™ºèƒ½ç´¢å¼•** | å»ºç«‹å¸‚åœº-åŒºå—æ˜ å°„ç´¢å¼•ï¼Œå¿«é€Ÿå®šä½æ•°æ® |
| **å¢é‡åŠ è½½** | åªè¯»å–æ–°æ•°æ®ï¼Œé¿å…é‡å¤ä¼ è¾“ |
| **æ—¶é—´è¿‡æ»¤** | æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰äº¤æ˜“æ•°æ® |
| **æ•°æ®è½¬æ¢** | å°†åŸå§‹é“¾ä¸Šæ•°æ®è½¬æ¢ä¸ºç­–ç•¥å¯ç”¨æ ¼å¼ |

---

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MarketDataLoader                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®æºå±‚    â”‚â”€â”€â”€â”€â–¶â”‚  ç¼“å­˜å±‚      â”‚â”€â”€â”€â”€â–¶â”‚  åº”ç”¨å±‚    â”‚  â”‚
â”‚  â”‚  (SMB)       â”‚     â”‚  (æœ¬åœ°ç£ç›˜)  â”‚     â”‚  (ç­–ç•¥)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                   â”‚                   â”‚          â”‚
â”‚          â–¼                   â–¼                   â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  markets.parquet    trades/*.parquet    index.pkl   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä½¿ç”¨

```python
from market_data_loader import MarketDataLoader, convert_raw_trades_to_market_format

# åˆ›å»ºåŠ è½½å™¨
loader = MarketDataLoader()

# å¸‚åœº ID (2020å¹´ç‰¹æœ—æ™®é€‰ä¸¾)
market_id = "0xf2e631ea675c5b09caea0bf65cf7887e25907af2657c8c907f02d9afbff20d05"

# è·å–å¸‚åœºä¿¡æ¯
info = loader.get_market_info(market_id)
print(f"é—®é¢˜: {info['question']}")
print(f"äº¤æ˜“é‡: {info['volume']}")

# åŠ è½½äº¤æ˜“æ•°æ®
trades = loader.get_market_trades(market_id)
print(f"äº¤æ˜“æ•°: {len(trades)}")

# è½¬æ¢ä¸ºç­–ç•¥æ ¼å¼
market_trades = convert_raw_trades_to_market_format(trades)
```

### é«˜çº§ç”¨æ³•

```python
# æŒ‡å®šæ—¶é—´èŒƒå›´
trades = loader.get_market_trades(
    market_id,
    start_time=datetime(2020, 11, 1),
    end_time=datetime(2020, 11, 30)
)

# è‡ªå®šä¹‰ç¼“å­˜ç›®å½•
loader = MarketDataLoader(
    cache_dir="/path/to/cache",
    use_cache=True
)

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
stats = loader.get_cache_stats()
print(f"ç¼“å­˜å¤§å°: {stats['total_cache_size_mb']} MB")

# æ¸…é™¤ç¼“å­˜
loader.clear_cache()
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
~/.cache/polymarket/
â”œâ”€â”€ markets.parquet              # å¸‚åœºå…ƒæ•°æ®ç¼“å­˜
â”œâ”€â”€ market_block_index.pkl       # å¸‚åœº-åŒºå—ç´¢å¼•
â””â”€â”€ trades/
    â”œâ”€â”€ a1b2c3d4.parquet        # å¸‚åœº1äº¤æ˜“ç¼“å­˜
    â”œâ”€â”€ e5f6g7h8.parquet        # å¸‚åœº2äº¤æ˜“ç¼“å­˜
    â””â”€â”€ ...
```

---

## ğŸ”§ API å‚è€ƒ

### MarketDataLoader ç±»

#### `__init__(data_path, cache_dir, use_cache)`

åˆå§‹åŒ–åŠ è½½å™¨ã€‚

**å‚æ•°ï¼š**
- `data_path`: æ•°æ®æºè·¯å¾„ï¼ˆé»˜è®¤ä½¿ç”¨ SMB æŒ‚è½½ç‚¹ï¼‰
- `cache_dir`: æœ¬åœ°ç¼“å­˜ç›®å½•ï¼ˆé»˜è®¤ `~/.cache/polymarket`ï¼‰
- `use_cache`: æ˜¯å¦å¯ç”¨ç¼“å­˜

#### `get_market_info(market_id) -> Dict`

è·å–å¸‚åœºè¯¦ç»†ä¿¡æ¯ã€‚

**è¿”å›ï¼š**
```python
{
    'condition_id': '0x...',
    'question': 'Will Trump win...',
    'end_date': datetime(...),
    'volume': 10802602,
    'outcomes': ['Yes', 'No'],
    'clob_token_ids': ['448047...', '944018...'],
    ...
}
```

#### `get_market_trades(market_id, start_time, end_time) -> pd.DataFrame`

è·å–å¸‚åœºäº¤æ˜“æ•°æ®ã€‚

**å‚æ•°ï¼š**
- `market_id`: å¸‚åœº condition_id
- `start_time`: å¼€å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰
- `end_time`: ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰

**è¿”å›ï¼š**
åŸå§‹é“¾ä¸Šäº¤æ˜“æ•°æ® DataFrameï¼ŒåŒ…å«ï¼š
- `block_number`: åŒºå—å·
- `transaction_hash`: äº¤æ˜“å“ˆå¸Œ
- `maker_asset_id`, `taker_asset_id`: Token IDs
- `maker_amount`, `taker_amount`: äº¤æ˜“æ•°é‡

#### `clear_cache()`

æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜ã€‚

#### `get_cache_stats() -> Dict`

è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ã€‚

---

### å·¥å…·å‡½æ•°

#### `convert_raw_trades_to_market_format(df) -> pd.DataFrame`

å°†åŸå§‹äº¤æ˜“æ•°æ®è½¬æ¢ä¸ºç­–ç•¥å¯ç”¨æ ¼å¼ã€‚

**è¾“å…¥ï¼š** åŸå§‹é“¾ä¸Šæ•°æ®
**è¾“å‡ºï¼š**
```python
{
    'timestamp': datetime,  # äº¤æ˜“æ—¶é—´
    'market': str,          # å¸‚åœºID
    'price': float,         # æˆäº¤ä»·æ ¼ (0-1)
    'size': float,          # äº¤æ˜“æ•°é‡
    'side': str             # 'BUY' æˆ– 'SELL'
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### é¦–æ¬¡åŠ è½½ vs ç¼“å­˜åŠ è½½

| æ“ä½œ | é¦–æ¬¡åŠ è½½ | ç¼“å­˜åŠ è½½ | åŠ é€Ÿæ¯” |
|------|---------|---------|--------|
| åŠ è½½ markets | ~5s | ~0.5s | 10x |
| åŠ è½½ trades | ~30-60s | ~1-2s | 30x+ |

### ä¼˜åŒ–å»ºè®®

1. **é¢„åŠ è½½å¸¸ç”¨å¸‚åœº**
   ```python
   # æ‰¹é‡åŠ è½½å¹¶ç¼“å­˜
   for market_id in popular_markets:
       loader.get_market_trades(market_id)
   ```

2. **å®šæœŸæ¸…ç†ç¼“å­˜**
   ```python
   # ç¼“å­˜ç›®å½•å¯èƒ½å˜å¤§ï¼Œå®šæœŸæ¸…ç†
   loader.clear_cache()
   ```

3. **å¢é‡æ›´æ–°**
   - ç›®å‰å®ç°ä¼šé‡æ–°åŠ è½½æ•´ä¸ªå¸‚åœºçš„æ•°æ®
   - æœªæ¥å¯ä¼˜åŒ–ä¸ºåªåŠ è½½æ–°åŒºå—çš„æ•°æ®

---

## ğŸ” æ•°æ®ç»“æ„è¯´æ˜

### Markets æ•°æ®

å­˜å‚¨åœ¨ `polymarket/markets/*.parquet`

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `condition_id` | å¸‚åœºå”¯ä¸€ID |
| `question` | é—®é¢˜æè¿° |
| `outcomes` | ç»“æœé€‰é¡¹ (JSON) |
| `clob_token_ids` | Token IDs (JSON) |
| `volume` | äº¤æ˜“é‡ |
| `end_date` | ç»“æŸæ—¥æœŸ |

### Trades æ•°æ®

å­˜å‚¨åœ¨ `polymarket/trades/trades_{start}_{end}.parquet`

æŒ‰åŒºå—èŒƒå›´åˆ†ç‰‡ï¼Œéœ€è¦é€šè¿‡ `clob_token_ids` è¿‡æ»¤ç‰¹å®šå¸‚åœºã€‚

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `block_number` | åŒºå—å· |
| `transaction_hash` | äº¤æ˜“å“ˆå¸Œ |
| `maker_asset_id` | Maker Token ID |
| `taker_asset_id` | Taker Token ID |
| `maker_amount` | Maker æ•°é‡ |
| `taker_amount` | Taker æ•°é‡ |

---

## ğŸ› æ•…éšœæ’é™¤

### SMB è¿æ¥å¤±è´¥

```python
# æ£€æŸ¥æŒ‚è½½ç‚¹
ls -la /Volumes/liuqiong/

# æ‰‹åŠ¨æŒ‚è½½
mount_smbfs 'smb://MM2018._smb._tcp.local/liuqiong' /Volumes/liuqiong
```

### ç¼“å­˜ç›®å½•æƒé™

```bash
# ç¡®ä¿ç¼“å­˜ç›®å½•å¯å†™
mkdir -p ~/.cache/polymarket
chmod 755 ~/.cache/polymarket
```

### å†…å­˜ä¸è¶³

å¯¹äºè¶…å¤§æ•°æ®é›†ï¼Œä½¿ç”¨åˆ†å—è¯»å–ï¼š

```python
# åˆ†å—å¤„ç†
df = loader.get_market_trades(market_id)
for chunk in pd.read_parquet(cache_path, chunksize=10000):
    process(chunk)
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `market_data_loader.py` - ä¸»å®ç°
- `00002_market_data_loader_demo.py` - ä½¿ç”¨ç¤ºä¾‹
- `data_adapter.py` - åŸºç¡€é€‚é…å™¨

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| 1.0 | 2026-02-18 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºç¡€ç¼“å­˜å’Œç´¢å¼• |

---

**æ³¨æ„ï¼š** æœ¬åŠ è½½å™¨é’ˆå¯¹ SMB ç½‘ç»œå­˜å‚¨ä¼˜åŒ–ï¼Œåœ¨æœ¬åœ° SSD ä¸Šä½¿ç”¨æ—¶æ€§èƒ½ä¼šæ›´å¥½ã€‚
